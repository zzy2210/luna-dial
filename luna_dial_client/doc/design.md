# Luna Dial TUI 客户端设计文档

## 项目概述

Luna Dial Client 是一个基于 Rust 和 ratatui 的终端用户界面（TUI）客户端，用于与服务器交互，管理任务和文档。

### 主要功能
- 从服务器获取指定时间/时间段的任务与文档
- 支持任务的层级管理（父子关系）
- 任务状态管理（未开始/进行中/已完成/已取消）
- 任务优先级管理（紧急/高/中/低）
- 任务分数标注（仅日任务）
- 文档的增删改查
- 多种时间视图（今日、本周、本月、本季度、本年）
- 全局任务树视图

### 任务层级规则
- Year → Quarter → Month → Week → Day
- 日任务不能创建子任务
- 子任务自动继承父任务的类型降一级

## 界面设计

### 总体布局
```
┌─────────────────────────────────────────────────┐
│  [全局任务] [今日] [本周] [本月]               │ ← 多行标签栏
│  [本季度] [本年] [执行情况] [自定义时间]       │
├─────────────────────────────────────────────────┤
│                 主内容区域                       │
│              (根据标签栏切换显示)                │
│                                                 │
├─────────────────────────────────────────────────┤
│ Tab:切换 Space:状态 p:优先级 e:执行情况 n:新建 q:退出│ ← 底部快捷键
└─────────────────────────────────────────────────┘
```

### 视图类型

#### 1. 全局任务视图
- 单栏显示，树形结构
- 支持展开/折叠
- 显示完整的任务层级关系
- **新增**：显示子任务数量标记
- **新增**：支持分页加载（每页10个根任务）

```
┌──────────── 任务树 ─────────────┐
│ ▼ 2025年度计划 [4个子任务]       │
│   ▼ Q1季度目标 [3个子任务]       │
│     ├ 1月任务 ✓[高]              │
│     └ 2月任务 ⏳[急]             │
│ ▶ 项目B [2个子任务]              │
│                                  │
│ [第1/3页] ← → 翻页               │
└─────────────────────────────────┘
```

#### 2. 时间视图（今日/本周/本月等）
- 左右分栏：任务列表 | 文档列表
- 任务显示格式：`[优先级] icon - 任务名称 状态`
- 日任务显示分数
- 显示任务的缩进层级关系

```
┌─────── 任务列表 ──────┐ ┌───── 相关文档 ─────┐
│[高] ⏳ 📝 完成设计文档  │ │ • 设计文档v1.0     │
│[急] ✓ 🔧 修复bug      │ │ • API接口文档      │
│       └ 分数: 8.5     │ │ • 需求分析         │
│[中] ⭕ 📞 团队会议     │ │                   │
└───────────────────────┘ └───────────────────────┘
```

#### 3. 执行情况视图（新增）
- 展示指定时间段的任务执行统计
- 显示相关日志列表
- 展示分数统计和趋势

##### 布局设计
```
┌────────────────── 2025年 执行情况 ──────────────────┐
│                                                      │
│  ┌─────────── 任务统计 ───────────┐                │
│  │ 总任务: 7                       │                │
│  │ ✓ 已完成: 4 (57.1%)  ████░░░░  │                │
│  │ ⏳ 进行中: 1 (14.3%)  █░░░░░░░  │                │
│  │ ⭕ 未开始: 1 (14.3%)  █░░░░░░░  │                │
│  │ ⛔ 已取消: 1 (14.3%)  █░░░░░░░  │                │
│  └─────────────────────────────────┘                │
│                                                      │
│  ┌─────────── 分数趋势 ───────────┐                │
│  │ 总分: 425                       │                │
│  │ 平均: 35.4/月                   │                │
│  │                                 │                │
│  │ 1月: ████████ 85               │                │
│  │ 2月: ██████ 65                 │                │
│  │ 3月: ███████ 72                │                │
│  │ 4月: █████ 55                  │                │
│  │ 5月: ████████ 80               │                │
│  │ 6月: ███ 35                    │                │
│  │ 7月: -- 待定                    │                │
│  │ ...                             │                │
│  └─────────────────────────────────┘                │
│                                                      │
│  ┌─────────── 相关日志 ───────────┐                │
│  │ 📝 2025-01-01 年初展望          │                │
│  │ 💭 2025-06-30 年中思考          │                │
│  │ 📊 2025-12-31 年末总结          │                │
│  └─────────────────────────────────┘                │
│                                                      │
│ [←前一年] [→后一年] [切换视图周期] [返回]          │
└──────────────────────────────────────────────────────┘
```

##### 不同周期的展示差异

**年度视图**：
- 任务统计：年度任务的状态分布
- 分数趋势：12个月的分数柱状图
- 相关日志：年度日志列表

**季度视图**：
- 任务统计：季度任务的状态分布
- 分数趋势：3个月的分数柱状图
- 相关日志：季度日志列表

**月度视图**：
- 任务统计：月度任务的状态分布
- 分数趋势：4周的分数柱状图
- 相关日志：月度日志列表

**周视图**：
- 任务统计：周任务的状态分布
- 分数趋势：7天的分数柱状图
- 相关日志：周志列表

**日视图**：
- 任务统计：当日任务的状态分布
- 分数详情：各任务的具体分数
- 相关日志：日志内容预览

##### 紧凑模式（适用于小屏幕）
```
┌──── 2025年 执行情况 ────┐
│ 任务: 7个               │
│ ✓4 ⏳1 ⭕1 ⛔1         │
│ 总分: 425 平均: 35.4    │
│                         │
│ 月度分数:               │
│ J:85 F:65 M:72 A:55    │
│ M:80 J:35 J:-- A:--    │
│ S:-- O:-- N:-- D:--    │
│                         │
│ 日志(3):                │
│ • 年初展望              │
│ • 年中思考              │
│ • 年末总结              │
└─────────────────────────┘
```

### 任务状态图标
- **⭕ 未开始**: 任务尚未开始
- **⏳ 进行中**: 任务正在进行
- **✓ 已完成**: 任务已经完成
- **⛔ 已取消**: 任务已被取消

### 优先级标识
- **[急]**: 🔴 红色高亮显示  // 简化为单字
- **[高]**: 🟠 橙色显示
- **[中]**: 🟡 黄色显示
- **[低]**: ⚪ 灰色显示

## 交互设计

### 基础操作
- **方向键/hjkl**: 上下选择项目
- **Tab**: 在任务列表和文档列表间切换焦点
- **Space**: 切换任务状态 ⭕→⏳→✓→⛔→⭕
- **Enter**: 编辑当前选中项
- **左右键**: 折叠/展开任务树节点
- **e**: 进入执行情况视图
- **[/]**: 在执行情况视图中切换时间周期
- **←/→**: 在执行情况视图中切换到前/后时间段
- **b**: 查看任务的父任务链
- **PageUp/PageDown**: 翻页（任务树和日志列表）
- **q**: 退出应用
- **Esc**: 返回上级/取消操作

### 编辑操作
- **s**: 编辑分数（仅日任务）
- **p**: 切换优先级 低→中→高→急→低
- **d**: 删除当前项
- **n**: 新建项目

### 鼠标支持
- **点击标签页**: 切换视图
- **点击任务/文档**: 选中项目
- **双击**: 进入编辑模式
- **滚轮**: 滚动长列表

## 新建流程

### 新建触发
```
按 n 键 → 弹出选择菜单：
┌─────────────┐
│ 1. 新建任务 │
│ 2. 新建文档 │
│ 3. 取消     │
└─────────────┘
```

### 新建任务
#### 空白任务（无选中项）
- 用户自由选择任务类型
- 手动设置所有字段

#### 子任务（基于当前选中）
- 自动填充父任务信息
- 任务类型自动降一级（可修改）
- 时间范围智能推荐
- 继承父任务标签

#### 智能默认规则
```
Year任务(2025) → Quarter子任务默认(2025-Q1)
Quarter任务(2025-Q1) → Month子任务默认(2025-01)
Month任务(2025-03) → Week子任务默认(2025-03第一周)
Week任务(2025-W10) → Day子任务默认(该周第一天)
```

#### 限制规则
- 选中日任务时，"新建任务"选项禁用

### 新建文档
- 设置标题、内容、图标
- 选择文档类型和时间范围

## 状态管理

### 应用状态
```rust
enum ViewMode {
    GlobalTree,           // 全局任务树
    TimeFiltered {        // 时间过滤视图
        period: TimePeriod,
        selected_task: Option<usize>,
        selected_doc: Option<usize>,
    },
    ExecutionStats {      // 执行情况视图（新增）
        period_type: PeriodType,
        current_date: DateTime<Local>,
        stats_data: Option<PlanStats>,
    }
}

enum TimePeriod {
    Today, Week, Month, Quarter, Year, Custom
}

enum PeriodType {         // 新增
    Day,
    Week, 
    Month,
    Quarter,
    Year,
}

enum TaskStatus {
    NotStarted,    // 未开始 ⭕
    InProgress,    // 进行中 ⏳
    Completed,     // 已完成 ✓
    Cancelled,     // 已取消 ⛔
}

enum TaskPriority {
    Low,       // 低 ⚪
    Medium,    // 中 🟡
    High,      // 高 🟠
    Urgent,    // 急 🔴
}

enum InputMode {
    Normal,           // 浏览模式
    EditingTaskName,  // 编辑任务名
    EditingScore,     // 编辑分数
    EditingDocument,  // 编辑文档
    CreatingTask,     // 创建任务
    CreatingDocument, // 创建文档
}

enum FocusedPanel {
    Tasks,
    Documents,
}

struct PlanStats {        // 新增，对应API返回的计划数据
    tasks: Vec<Task>,
    tasks_total: u32,
    journals: Vec<Journal>,
    journals_total: u32,
    score_total: u32,
    group_stats: Vec<GroupStat>,
}

struct GroupStat {        // 新增，对应API的分组统计
    group_key: String,    // 如 "2025-01", "2025-W32" 等
    task_count: u32,
    score_total: u32,
}

struct Task {             // 增强的任务结构
    id: String,
    title: String,
    task_type: TaskType,  // daily/weekly/monthly/quarterly/yearly
    // 树结构优化字段
    has_children: bool,
    children_count: u32,
    tree_depth: u32,
    root_task_id: Option<String>,
    parent_id: Option<String>,
    children: Vec<Task>,  // 嵌套子任务
    // 其他字段...
}

enum TaskType {
    Daily,
    Weekly, 
    Monthly,
    Quarterly,  // 新增
    Yearly,
}
```

## 技术栈

### 依赖库
- **ratatui**: TUI 框架
- **crossterm**: 跨平台终端操作
- **reqwest**: HTTP 客户端
- **serde**: 序列化/反序列化
- **anyhow**: 错误处理
- **chrono**: 时间处理

### 通信协议
- **HTTP REST**: 与服务器通信
- **JSON**: 数据交换格式
- 暂不考虑离线缓存

## 开发计划

### 阶段1：基础框架
1. 添加依赖到 Cargo.toml
2. 定义 Rust 数据结构
3. 创建基础 TUI 框架
4. 实现主循环和视图切换

### 阶段2：界面实现
1. 实现标签栏和基础布局
2. 创建全局任务树视图
3. 创建时间过滤视图
4. 用静态数据测试界面效果

### 阶段3：交互功能
1. 实现键盘和鼠标事件处理
2. 添加任务/文档的增删改查
3. 实现编辑模式和状态管理

### 阶段4：网络功能
1. 集成 HTTP 客户端
2. 实现与服务器的数据同步
3. 添加错误处理和用户反馈

### 阶段5：优化完善
1. 性能优化
2. 用户体验改进
3. 添加配置文件支持
4. 文档和测试

## 备注

- 设计遵循 TUI 应用的常规模式
- 支持键盘和鼠标双重操作方式
- 界面简洁，重视实用性
- 数据结构与后端 Go 服务保持一致

## 执行情况视图功能详述

### 数据来源
- 使用 `/api/v1/plans` API 获取数据
- 根据选择的时间周期类型（period_type）和时间范围请求数据
- 利用返回的 `group_stats` 字段展示分组统计

### 任务统计面板
- 实时计算任务状态分布
- 显示百分比和进度条
- 不同状态用不同颜色区分
- 支持点击查看具体任务列表

### 分数趋势面板
- 根据 `group_stats` 中的数据绘制
- 年视图：显示12个月的分数
- 季度视图：显示3个月的分数
- 月视图：显示4周的分数
- 周视图：显示7天的分数
- 日视图：显示各任务的具体分数明细

### 日志面板
- 显示对应时间段的日志列表
- 显示日志图标、日期和标题
- 支持 Enter 键查看日志详情
- 最多显示最近的10条日志

### 交互功能
1. **时间导航**
   - 左右箭头键切换到前后时间段
   - 自动更新显示内容
   
2. **周期切换**
   - 使用 `[` 和 `]` 键切换查看周期
   - 从日→周→月→季度→年循环
   
3. **详情查看**
   - Enter 键查看选中项的详情
   - 支持查看任务详情和日志内容
   
4. **快速跳转**
   - `t` 键跳转到今天
   - `g` 键输入日期跳转

### 响应式设计
- 窗口宽度 > 100 字符：完整视图
- 窗口宽度 60-100 字符：紧凑视图
- 窗口宽度 < 60 字符：垂直布局
